version: '3.8'

services:
  # Redis service for log queue
  redis:
    image: redis:7-alpine
    container_name: siem-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped

  # PostgreSQL database (optional - can use SQLite instead)
  postgres:
    image: postgres:15-alpine
    container_name: siem-postgres
    environment:
      POSTGRES_DB: siem_analyzer
      POSTGRES_USER: siem_user
      POSTGRES_PASSWORD: siem_password
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  # SIEM Analyzer application
  siem-analyzer:
    build: .
    container_name: siem-analyzer
    depends_on:
      - redis
      # - postgres # Not needed for SQLite v1
    environment:
      # Database configuration - using SQLite for v1
      DATABASE_TYPE: sqlite
      DATABASE_URL: sqlite:////data/siem_analyzer.db
      
      # Redis configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      # Email configuration (optional)
      EMAIL_ENABLED: "false"
      
      # Log level
      LOG_LEVEL: INFO
    volumes:
      - ./logs:/app/logs
      - ./reports:/app/reports
      - ./config:/app/config
      - ./scripts:/app/scripts
      - ./data:/data  # Mount data directory for SQLite DB
    restart: unless-stopped

  # Grafana for visualization
  grafana:
    image: grafana/grafana-oss:latest
    container_name: siem-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_INSTALL_PLUGINS=fr-ser-sqlite-datasource
      - GF_SECURITY_ADMIN_PASSWORD=admin  # Default password
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./data:/data:ro  # Read-only access to SQLite DB
    depends_on:
      - siem-analyzer
    restart: unless-stopped

volumes:
  redis-data:
  postgres-data:
  grafana-data:
